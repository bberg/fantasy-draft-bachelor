var profileServiceClient=profileServiceClient||{};profileServiceClient.settings={profileServiceUrl:"http://api.profile.abc.go.com/api/ws/profile/v1/profiles/",brand:"abc",debug:!1,enabled:!1},profileServiceClient&&profileServiceClient.settings&&profileServiceClient.settings.hasOwnProperty("enabled")&&profileServiceClient.settings.enabled===!1&&(profileServiceClient=void 0),function(a,b){"use strict";function c(){var a={url:"http://api.utils.watchabc.go.com/vp2/ws/utils/2015/geo/jsonp/video/geolocation/001/001/gt/-1",method:"GET",dataType:"json"},b=$.Deferred();return $.ajax(a).done(function(a){return t.getABCSwid()?(o("success generateSwid",a),void b.resolve(t.getABCSwid())):(n("failed generateSwid","No cookie after request"),void b.reject(a))}).fail(function(a){n("failed generateSwid",a),b.reject(a)}),b.promise()}function d(a,b,c,d){var f=$.Deferred();if(c||(c={}),d){var g=d.map(function(a){var b=a.validationFn(a.value);return b?void 0:new Error(a.message+a.value)}).filter(function(a){return a});if(g.length>0)return n("failed request validation ",{errors:g}),f.reject({errors:g}),f.promise()}return e().done(function(d){var e={url:a.url||i(a.suffix,b,d.swid),method:a.method,headers:{Authorization:"JWT "+d.jwt,Accept:"application/json","Content-Type":"application/json"}};if(c.data){var g=c.data;"object"==typeof g&&(g=JSON.stringify(g)),e.data=g}$.ajax(e).done(function(a){o("success request",a),f.resolve(a)}).fail(function(a){n("failed request",a),f.reject(a)})}).fail(function(a){n("failed prepareRequestAuthData",a),f.reject(a)}),f.promise()}function e(){var a=$.Deferred(),b=t.getJWT(),c=t.getProfileId(),d=t.getABCSwid();if(b&&c&&c===d){var e={jwt:b,swid:c};g(e),a.resolve(e)}else f().done(function(b){g(b),a.resolve(b)}).fail(function(b){var c=b.error?b.error():void 0;c&&403===c.status?(o('JWT "expired". New SWID and JWT required: generating.'),t.removeABCSwid(),f().done(function(b){a.resolve(b)}).fail(function(b){n("failed to regenerate SWID",b),a.reject(b)})):(n("failed to regenerate JWT",b),a.reject(b))});return a.promise()}function f(){var a=$.Deferred();return j().done(function(b){var c=t.getJWT();if(t.setProfileId(b),c&&b)a.resolve({jwt:c,swid:b});else{var d={url:i(q.ANONYMOUS_BIND.suffix,null,b),method:q.ANONYMOUS_BIND.method,data:JSON.stringify({swid:b})};$.ajax(d).done(function(c){o("success bindAnonymous",c),t.setJWT(c.jwt),a.resolve({jwt:c.jwt,swid:b})}).fail(function(b){t.setJWT(null),n("failed bindAnonymous",b),a.reject(b)})}}).fail(function(b){a.reject(b)}),a.promise()}function g(a){if(!p){var b=t.getSynced();!b&&a.swid&&(b=a.swid,t.setSynced(b),t.setVideosForSync(t.getABCVideoCookie())),h()}}function h(a){if(t.getSynced()&&t.getSynced()===t.getABCSwid()&&(!p||a)){var b=t.getVideosForSync();if(b&&0!==b.length){p=!0;var c=b[0];profileServiceClient.setVideoProgress(c.id,c.p).done(function(){b=t.getVideosForSync(),b.shift(),t.setVideosForSync(b),h(!0)}).fail(function(){p=!1})}}}function i(a,c,d){c=c||{},c.brand=b.brand,c.swid=d;var e=k(b.profileServiceUrl);e+=q.SWID.suffix+a;for(var f in c)c.hasOwnProperty(f)&&(e=e.replace(new RegExp("\\{"+f+"\\}","g"),c[f]));return e}function j(){var a=$.Deferred(),b=t.getABCSwid(),d=t.getProfileId();return b?(b!==d&&t.clearUserData(),a.resolve(b),a.promise()):(t.clearUserData(),c())}function k(a){return a?(a.lastIndexOf("/")!=a.length-1&&(a+="/"),a):(n("Url is empty! url: ","URL should be here but it is really empty."),a)}function l(a){var b=!0;return 0===a||null==a||void 0==a?b:("number"!=typeof a&&(b=!1),0>a&&(b=!1),b)}function m(a){if(a=a&&"string"==typeof a?a.toLowerCase():!1){a.match(/[\w].*?_[\w].*/)}return a}if(b){var n=function(){},o=function(){},p=!1;void 0===a.console?a.console={log:function(){},error:function(){}}:b.debug&&(n=function(a,b){console.error("ProfileServiceClient error:  "+a,b)},o=function(a,b){console.log("ProfileServiceClient log:  "+a,b)});var q={SWID:{suffix:"{swid}/"},ANONYMOUS_BIND:{suffix:"anonymous-bind",method:"POST"},TRACK_PROGRESS:{suffix:"brands/{brand}/lists/history/{videoId}",method:"POST"},GET_VIDEO_PROGRESS:{suffix:"brands/{brand}/lists/history/{videoId}",method:"GET"},REQUEST_HISTORY_SHORT:{suffix:"brands/{brand}/lists/history",method:"GET"},REQUEST_HISTORY_FULL:{url:"http://preview.api.presentation.abc.go.com/api/ws/d/presentation/v2/module/613732?brand=001&device=001&authlevel=0&start=%START%&size=%SIZE%",method:"GET"},REMOVE_FROM_HISTORY:{suffix:"brands/{brand}/lists/history/{videoId}",method:"DELETE"},DISNEY_ID_BIND:{suffix:"/v1/profiles/{swid}/brands/{brand}/profile-bind",method:"POST"}},r=function(){};r.prototype.setVideoProgress=function(a,b,c){var e={type:"VIDEO",progress:b};return c&&(e.isCompleted=!0),d(q.TRACK_PROGRESS,{videoId:m(a)},{data:e},[{validationFn:m,value:a,message:"videoId is not valid! videoId: "},{validationFn:l,value:b,message:"Progress is not valid! progress: "}])},r.prototype.getVideoProgress=function(a){return d(q.GET_VIDEO_PROGRESS,{videoId:m(a)},null,[{validationFn:m,value:a,message:"videoId is not valid! videoId: "}])},r.prototype.getHistoryShort=function(){return d(q.REQUEST_HISTORY_SHORT)},r.prototype.getHistory=function(a,b,c){var e=a?a.replace("%START%",b||0).replace("%SIZE%",c||-1):a,f={url:e,method:q.REQUEST_HISTORY_FULL.method};return d(f,null,null,[{validationFn:function(a){return!!a},value:f.url,message:"Url is not defined! url: "},{validationFn:l,value:b,message:"Start is not valid! start: "},{validationFn:l,value:c,message:"Size is not valid! size: "}])},r.prototype.removeFromHistory=function(a){return d(q.REMOVE_FROM_HISTORY,{videoId:m(a)},null,[{validationFn:m,value:a,message:"videoId is not valid! videoId: "}])},b.debug&&(r.prototype.bindAnonymous=f,r.prototype.generateSwid=c,r.prototype.removeABCSwid=function(){t.removeABCSwid()},r.prototype.getVideoCookie=function(){t.getABCVideoCookie()});var s=function(a){var c=b.profileServiceUrl?b.profileServiceUrl.replace(/\/|\.|-|:/g,""):"undefined",d=null,e="jwt",f="profileId",g="synced",h="videosForSync",i="SWID",j=function(a){var b=m();return b[c][a]},k=function(a,b){var d=m();""===b||null===b||void 0===b?delete d[c][a]:d[c][a]=b,l(d)};this.setJWT=function(a){k(e,a)},this.getJWT=function(){return j(e)},this.setProfileId=function(a){k(f,a)},this.getProfileId=function(){return j(f)},this.setSynced=function(a){k(g,a)},this.getSynced=function(){return j(g)},this.setVideosForSync=function(a){k(h,a)},this.getVideosForSync=function(){return j(h)},this.clearUserData=function(){this.setJWT(null),this.setProfileId(null),this.setVideosForSync(null)},this.getABCSwid=function(){return $.cookie(i)},this.removeABCSwid=function(){return $.cookie(i,null,{path:"/",domain:".go.com",expires:-1})},this.getABCVideoCookie=function(){var a=$.cookie("abc_vp_me"),b={id:null,p:0};if(!a)return[];var c=a.split("||").map(function(a){var c={};a.split("++").map(function(a){for(var d in b)if(-1!=a.indexOf(d+"=="))return void(c[d]=a.replace(d+"==",""))});var d=c.p;return d&&"0"!==d?(c.p=1*d,c):void 0}).filter(function(a){return a});return c};var l=function(b){var c=encodeURIComponent(JSON.stringify(b));$.cookie(a,c,{path:"/",domain:document.domain,expires:3650})},m=function(){if(d)return d;var b=$.cookie(a)||"{}";return b=decodeURIComponent(b),b=JSON.parse(b),b||(b={}),b[c]||(b[c]={}),b[e]&&delete b[e],b[f]&&delete b[f],d=b,b}},t=new s(b.brand+"_psc_data");a.profileServiceClient=new r}}(window,profileServiceClient?profileServiceClient.settings:null);